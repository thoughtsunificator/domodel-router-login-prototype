window.BASE_PATH="/domodel-router-login-prototype",window.BASE_HREF="/domodel-router-login-prototype",function(){"use strict";class e{constructor(e){this._observable=e}get observable(){return this._observable}}class t{constructor(e,t,i){this._observable=e,this._eventName=t,this._callback=i}remove(){this._observable.removeListener(this)}get eventName(){return this._eventName}get callback(){return this._callback}}class i{constructor(){this._listeners={}}listen(e,i,r=!1){Array.isArray(this._listeners[e])||(this._listeners[e]=[]);const n=new t(this,e,i);return r?this._listeners[e].unshift(n):this._listeners[e].push(n),n}removeListener(e){this._listeners[e.eventName]=this._listeners[e.eventName].filter((t=>t!==e))}emit(e,t){if(Array.isArray(this._listeners[e]))for(const i of this._listeners[e].slice())i.callback(t)}}class r{constructor(t,r=new e(new i)){this._identifier={},this._properties={...t},this._parent=null,this._root=null,this._model=null,this._children=[],this._listeners=[],this._eventListener=r}get identifier(){return this._identifier}get properties(){return this._properties}get root(){return this._root}get model(){return this._model}get eventListener(){return this._eventListener}listen(e,t,i,r=!1){const n=e.listen(t,i,r);return r?this._listeners.unshift(n):this._listeners.push(n),n}run(e,t){t.binding._parent=this,this._children.push(t.binding),t.binding._properties={...this.properties,...t.binding.properties},n.run(e,{parentNode:this.root,...t})}remove(){const e=this._listeners.slice();for(const t of e)t.remove();const t=this._children.slice();for(const e of t)e.remove();null!==this._parent&&(this._parent._children=this._parent._children.filter((e=>e!==this))),this.root.remove()}onCreated(){}async onRendered(){}}class n{static PROPERTIES=["tagName","children","identifier","model","binding","properties"];static METHOD={APPEND_CHILD:"APPEND_CHILD",INSERT_BEFORE:"INSERT_BEFORE",REPLACE_NODE:"REPLACE_NODE",WRAP_NODE:"WRAP_NODE",PREPEND:"PREPEND"};static run(e,{parentNode:t,binding:i=new r,method:o=n.METHOD.APPEND_CHILD}={}){const s=n.createNode(t,e,i);i._root=s,i._model=e;for(const e of Object.getOwnPropertyNames(Object.getPrototypeOf(i.eventListener)).filter((e=>"constructor"!==e&&"function"==typeof i.eventListener[e])))i.listen(i.eventListener.observable,e,i.eventListener[e].bind(i),!0);i.onCreated(),o===n.METHOD.APPEND_CHILD?t.appendChild(s):o===n.METHOD.INSERT_BEFORE?t.parentNode.insertBefore(s,t):o===n.METHOD.REPLACE_NODE?t.replaceWith(s):o===n.METHOD.WRAP_NODE?(s.appendChild(t.cloneNode(!0)),t.replaceWith(s)):o===n.METHOD.PREPEND&&t.prepend(s),i.onRendered()}static createNode(e,t,i){const{tagName:r,children:o=[]}=t,s=e.ownerDocument.createElement(r);Object.keys(t).filter((e=>!1===n.PROPERTIES.includes(e))).forEach((function(e){s[e]=t[e]}));for(const t of o)if(!0===Object.prototype.hasOwnProperty.call(t,"model")){let e;!0===Object.prototype.hasOwnProperty.call(t,"binding")&&(e=new t.binding({...i.properties,...t.properties}),!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=e)),i.run(t.model,{parentNode:s,binding:e})}else{const r=n.createNode(e,t,i);s.appendChild(r)}return!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=s),s}}class o{constructor(e,t){this._model=e,this._binding=t}get model(){return this._model}get binding(){return this._binding}}class s{static TYPE={PATH:"PATH",PARAMETER:"PARAMETER",SEPARATOR:"SEPARATOR"};constructor(e,t,i){this._type=e,this._buffer=t,this._bufferIndex=i}get type(){return this._type}get buffer(){return this._buffer}get bufferIndex(){return this._bufferIndex}}class a{static SEPARATOR="/";static PARAMETER_PREFIX="{";static PARAMETER_SUFFIX="}";static tokenize(e){const t=[],i=[...e];let r="";for(const[e,n]of i.entries()){r+=n;const o=e-r.length+1;if(r[0]===a.PARAMETER_PREFIX&&n===a.PARAMETER_SUFFIX){if(1===r.length)continue;t.push(new s(s.TYPE.PARAMETER,r,o)),r=""}else if(r[0]===a.PARAMETER_PREFIX){if(1===r.length)continue;n===a.SEPARATOR?(t.push(new s(s.TYPE.PATH,r.slice(-1),o)),t.push(new s(s.TYPE.SEPARATOR,n,o-r.length)),r=""):e===i.length-1&&t.push(new s(s.TYPE.PATH,r,o))}else if(n===a.SEPARATOR)t.push(new s(s.TYPE.SEPARATOR,r,o)),r="";else{const e=t[t.length-1];e&&e.type===s.TYPE.PATH?t[t.length-1]=new s(s.TYPE.PATH,e.buffer+r,e.bufferIndex):t.push(new s(s.TYPE.PATH,r,o)),r=""}}return t}}class l{constructor({match:e,model:t,binding:i=r,properties:n={},middleware:o,layout:s}={}){this._match=e,this._model=t,this._binding=i,this._properties=n,this._middleware=o,this._layout=s}get match(){return this._match}get model(){return this._model}get binding(){return this._binding}get properties(){return this._properties}get middleware(){return this._middleware}get layout(){return this._layout}}class h{constructor(e,t={}){this._route=e,this._parameters=t}get route(){return this._route}get parameters(){return this._parameters}}var d=e=>({tagName:"div",textContent:`No route was found for path "${e.router.path}"`});class u extends i{static TYPE={VIRTUAL:"VIRTUAL",PATHNAME:"PATHNAME",HASH:"HASH"};constructor({routes:e,type:t=u.TYPE.VIRTUAL,errorRoute:i,initialPath:n="/",defaultLayout:o,basePath:s=""}={}){super(),this._routes=e,this._type=t,this._errorRoute=i||new l({model:d,binding:r}),this._initialPath=n,this._view=null,this._path=null,this._defaultLayout=o,this._basePath=s}match(e){const t=a.tokenize(e);"/"===t[t.length-1]?.buffer&&t.pop();for(const e of this.routes){const i=[],r=a.tokenize(e.match);if("/"===r[r.length-1]?.buffer&&r.pop(),r.length===t.length){for(const[e,n]of t.entries())(r[e].buffer===n.buffer||r[e].type===s.TYPE.SEPARATOR||r[e].type===s.TYPE.PARAMETER&&n.type===s.TYPE.PATH)&&i.push(r[e]);if(i.length===t.length){const i={};for(const[e,n]of t.entries())r[e].type===s.TYPE.PARAMETER&&n.type===s.TYPE.PATH&&(i[r[e].buffer.slice(1,-1)]=decodeURIComponent(n.buffer));return new h(e,i)}}}return null}get routes(){return this._routes}get type(){return this._type}get errorRoute(){return this._errorRoute}get initialPath(){return this._initialPath}get view(){return this._view}get path(){return this._path}get defaultLayout(){return this._defaultLayout}get basePath(){return this._basePath}}class p extends i{constructor(e={}){super(),this._parameters=e}get parameters(){return this._parameters}get binding(){return this._binding}set binding(e){this._binding=e}}class c{constructor(e,t={}){this._path=e,this._properties=t}get path(){return this._path}get properties(){return this._properties}}class g extends e{navigate(e){let t=e.path;this.properties.router.type===u.TYPE.HASH&&(t=`#${e.path}`),this.root.ownerDocument.defaultView.history.pushState({},null,`${this.properties.router.basePath}${t}`),this.properties.router.emit("browse",e)}browse(e){const t=this.properties.router.match(e.path);if(t){if(t.route.middleware&&t.route.middleware(this.properties))return;this.properties.router.emit("routeSet",{match:t,link:e})}else this.properties.router.emit("routeSet",{match:new h(this.properties.router.errorRoute),link:new c(e.path,{path:e.path})})}routeSet(e){const{match:t,link:i}=e;null!==this.properties.router.view&&(this.layoutBinding?(this.layoutBinding.remove(),this._layoutBinding=null):this.properties.router.view.binding.remove()),this.properties.router._path=i.path,this.properties.router._view=new p(t.parameters),this.properties.router.view.binding=new t.route.binding({...this.properties,...t.route.properties,...i.properties});let r=t.route.model(this.properties),n=this;t.route.layout?(n=new t.route.layout.binding,this.run(t.route.layout.model,{binding:n})):this.properties.router.defaultLayout&&(n=new this.properties.router.defaultLayout.binding,this.run(this.properties.router.defaultLayout.model,{binding:n})),n!==this&&(this._layoutBinding=n),n.run(r,{parentNode:n.identifier.view,binding:this.properties.router.view.binding})}}class m extends r{constructor(e){super(e,new g(e.router))}onCreated(){const{router:e}=this.properties;if(this.root.ownerDocument.defaultView.addEventListener("popstate",(()=>{if(e.type===u.TYPE.HASH){let t=this.root.ownerDocument.location.hash.slice(1);""===t?e.emit("navigate",new c("/")):e.emit("browse",new c(t))}else e.type===u.TYPE.PATHNAME&&e.emit("browse",new c(this.root.ownerDocument.location.pathname.slice(e.basePath.length)))})),null!==e.initialPath)if(e.type===u.TYPE.VIRTUAL)e.emit("browse",new c(e.initialPath));else{let t;e.type===u.TYPE.PATHNAME&&"/"!==this.root.ownerDocument.location.pathname.slice(e.basePath.length)?t=this.root.ownerDocument.location.pathname.slice(e.basePath.length):e.type===u.TYPE.HASH&&""!==this.root.ownerDocument.location.hash.slice(1)&&(t=this.root.ownerDocument.location.hash.slice(1)),t?e.emit("browse",new c(t)):e.emit("navigate",new c(e.initialPath))}}get path(){return this._path}get view(){return this._view}get layoutBinding(){return this._layoutBinding}}var _={tagName:"div",children:[{tagName:"h1",textContent:"domodel-router-login-prototype"},{tagName:"div",identifier:"nav"},{tagName:"div",identifier:"view"}]},f={tagName:"div",children:[{tagName:"div",children:[{tagName:"button",identifier:"linkA",textContent:"Link A"},{tagName:"button",identifier:"linkB",textContent:"Link B"},{tagName:"button",identifier:"linkC",textContent:"Link C"},{tagName:"button",identifier:"logout",textContent:"Logout"}]},{tagName:"div",identifier:"view"}]},E={tagName:"div",identifier:"view"};class P extends m{onCreated(){super.onCreated();const{app:e,router:t}=this.properties;this.listen(e,"login",(()=>{localStorage.setItem("logged",""),e._logged=!0,t.emit("navigate",{path:"/protected"})})),this.listen(e,"logout",(()=>{localStorage.removeItem("logged"),e._logged=!1,t.emit("navigate",{path:"/login"})}))}}class b extends r{onCreated(){const{app:e,router:t}=this.properties;this.identifier.linkA.addEventListener("click",(()=>{t.emit("navigate",{path:"/a"})})),this.identifier.linkB.addEventListener("click",(()=>{t.emit("navigate",{path:"/b"})})),this.identifier.linkC.addEventListener("click",(()=>{t.emit("navigate",{path:"/c"})})),this.identifier.logout.addEventListener("click",(()=>{e.emit("logout")}))}}class w extends i{constructor(){super(),this._logged=!1}get logged(){return this._logged}}function A(e){if(!e.app.logged)return e.router.emit("navigate",{path:"/login"}),!0}var v=[new l({match:"/login",model:e=>({tagName:"form",children:[{tagName:"button",textContent:"Login"}]}),binding:class extends r{onCreated(){const{app:e}=this.properties;this.root.addEventListener("submit",(t=>{t.preventDefault(),e.emit("login")}))}},middleware:e=>{if(e.app.logged)return e.router.emit("navigate",{path:"/protected"}),!0},layout:new o({tagName:"div",identifier:"view"},r)}),new l({match:"/protected",model:e=>({tagName:"div",children:[{tagName:"div",textContent:"Protected"}]}),binding:class extends r{onCreated(){this.properties}},middleware:A}),new l({match:"/a",model:e=>({tagName:"div",textContent:"Page A"}),binding:r,middleware:A}),new l({match:"/b",model:e=>({tagName:"div",textContent:"Page B"}),binding:r,middleware:A}),new l({match:"/c",model:e=>({tagName:"div",textContent:"Page C"}),binding:r,middleware:A})];window.addEventListener("load",(function(){const e=new w;e._logged=null!==localStorage.getItem("logged");const t=new u({routes:v,basePath:window.BASE_PATH,type:u.TYPE.PATHNAME,initialPath:"/login",errorRoute:new l({model:d,layout:new o(E,r)}),defaultLayout:new o(f,b)});n.run(_,{binding:new P({app:e,router:t}),parentNode:document.body})}))}();
